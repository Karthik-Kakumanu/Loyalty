// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- USER & AUTH ---
model User {
  id          String        @id @default(cuid())
  name        String?
  phone       String        @unique
  dob         DateTime?
  state       String?
  city        String?
  interests   String[]
  image       String?
  role        String        @default("user") 
  fcmToken    String?  
  
  cards       LoyaltyCard[]
  reservations Reservation[]
  history     Transaction[]
  stamps      StampHistory[]
  userRewards UserReward[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Otp {
  id        String   @id @default(cuid())
  phone     String   @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// --- CAFE & OPERATIONS ---
model Cafe {
  id          String   @id @default(cuid())
  name        String
  description String?
  address     String
  city        String?  
  image       String?  
  lat         Float?
  lng         Float?
  rating      Float    @default(4.5)
  totalTables Int      @default(10)
  visitCount  Int      @default(0) 
  
  // --- NEW FIELDS FOR SERIAL NUMBERS ---
  cardPrefix  String?  @default("MEM") // e.g. "CR" for Cake Roven
  nextCardSeq Int      @default(1)     // Tracks the next number (e.g. 0001)

  cards        LoyaltyCard[]
  reservations Reservation[]
  rewards      Reward[]
  
  createdAt DateTime @default(now())
}

model Reservation {
  id        String   @id @default(cuid())
  userId    String
  cafeId    String
  date      DateTime 
  guests    Int
  status    String   @default("PENDING") 
  
  user      User     @relation(fields: [userId], references: [id])
  cafe      Cafe     @relation(fields: [cafeId], references: [id])
  
  createdAt DateTime @default(now())
}

// --- LOYALTY ENGINE ---
model LoyaltyCard {
  id          String   @id @default(cuid())
  userId      String
  cafeId      String
  
  // --- NEW FIELD FOR THE VISIBLE ID ---
  cardSerial  String?  // e.g. "CR0001", "SB0013"
  
  balance     Int      @default(0) 
  stamps      Int      @default(0) 
  maxStamps   Int      @default(10) 
  tier        String   @default("Silver") 
  totalSpends Float    @default(0.0)
  
  user        User     @relation(fields: [userId], references: [id])
  cafe        Cafe     @relation(fields: [cafeId], references: [id])
  transactions Transaction[]
  stampHistory StampHistory[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, cafeId])
}

model StampHistory {
  id        String   @id @default(cuid())
  userId    String
  cardId    String
  action    String   
  amount    Int      
  
  user      User        @relation(fields: [userId], references: [id])
  card      LoyaltyCard @relation(fields: [cardId], references: [id])
  
  createdAt DateTime @default(now())
}

model Reward {
  id          String   @id @default(cuid())
  cafeId      String
  title       String
  cost        Int      
  description String?
  
  cafe        Cafe     @relation(fields: [cafeId], references: [id])
}

model UserReward {
  id          String   @id @default(cuid())
  userId      String
  title       String
  cafeName    String
  expiry      String   
  status      String   @default("READY") 
  pointsUsed  Int
  
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
}

model Transaction {
  id           String      @id @default(cuid())
  userId       String
  cardId       String
  amount       Float       
  pointsEarned Int
  type         String      
  
  user         User        @relation(fields: [userId], references: [id])
  card         LoyaltyCard @relation(fields: [cardId], references: [id])
  
  createdAt    DateTime    @default(now())
}